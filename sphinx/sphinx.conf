#!/usr/bin/php
<?php include ("/path_to_logzilla/html/config/config.php");?>
#
# Sphinx configuration file for LogZilla
# Documentation for sphinx can be found at http://sphinxsearch.com/docs/
#

#############################################################################
## indexer settings
#############################################################################
indexer
{
        # Set to your liking, default is 32M, but I have 26G available
        # so I set it to 1024M for testing
        # A more "sane" setting may be 256M which will process about 600k rows at a time
        # See http://sphinxsearch.com/docs/current.html#conf-mem-limit for more information
        #mem_limit                       = 1024M
        mem_limit                       = 128M
}
#############################################################################
## searchd settings
#############################################################################
searchd
{

        listen                         = 127.0.0.1
        port                            = 3312
        # Max matches is set to 1000 by default
        # Note that if you make these numbers too high, you may run out of memory
        max_matches                 = 10000
        log                                     = /path_to_logzilla/sphinx/log/sphinx_searchd.log
        query_log                       = /path_to_logzilla/sphinx/log/sphinx_query.log
        read_timeout            = 5
        max_children            = 30
        seamless_rotate     = 1
        unlink_old                      = 1
        pid_file                        = /var/run/sphinx_searchd.pid
}
index distributed
{
                type = distributed
                                agent = 127.0.0.1:3312:idx_logs, idx_delta_logs
}
#############################################################################
## data source definition
#############################################################################
source s_logs
{
        type                            = mysql
        sql_host                        = <?php echo DBHOST."\n";?>
        sql_user                        = <?php echo DBADMIN."\n";?>
        sql_pass                        = <?php echo DBADMINPW."\n";?>
        sql_db                          = <?php echo DBNAME."\n";?>
        sql_port                        = <?php echo DBPORT."\n";?>     # optional, default is 3306
        sql_query_range         = SELECT MIN(id),MAX(id) FROM logs
        # set range step to whatever you like, 1m on larger systems should be ok
        # See http://sphinxsearch.com/docs/current.html#conf-sql-range-step
        sql_range_step      = 100000
        sql_query_pre           = UPDATE sph_counter SET max_id= (SELECT MAX(id) FROM logs) WHERE index_name = 'idx_logs'
        sql_query                       = SELECT \
                                                        id, host, facility, severity, program, \
                                                        msg, mne, eid, notes, counter, UNIX_TIMESTAMP(fo) AS fo, UNIX_TIMESTAMP(lo) AS lo \
                                                        FROM logs\
                                                WHERE id >= $start AND id <= $end
	sql_attr_timestamp      = fo
        sql_attr_timestamp      = lo
        sql_attr_uint		= counter:11
        sql_attr_uint		= eid:16
        sql_attr_uint		= facility:7
        sql_attr_uint       = severity:7
		sql_query_post      =
        sql_query_info      = SELECT * FROM logs WHERE id=$id
}

source s_delta_logs : s_logs
{
        sql_query_pre           = UPDATE sph_counter SET max_id= (SELECT MAX(id) FROM logs) \
                                                        WHERE index_name = 'idx_delta_logs'
        sql_query_range         = SELECT \
                                                        MIN(id),MAX(id) FROM logs WHERE id > \
                                                        (SELECT max_id FROM sph_counter WHERE index_name = 'idx_logs')
}
#############################################################################
## index definition
#############################################################################
index idx_logs
{
        source                  = s_logs
        path                    = /path_to_logzilla/sphinx/data/idx_logs
        docinfo                 = extern
        min_word_len            = 3
        charset_type            = utf-8
        # The charset table below is set to include periods (.) and @'s so that ip addresses and email addresses get indexed as a single, searchable, word.
        charset_table = 0..9, A..Z->a..z, _, a..z, U+A8->U+B8, U+B8, U+C0..U+DF->U+E0..U+FF, U+E0..U+FF, U+2E, U+2D, U+40, U+3D

        # min-prefix will enable wildcard matches but will *drastically* increase the index sizes
#        enable_star            = 1
#        min_prefix_len         = 3
}
index idx_delta_logs : idx_logs
{
    source          = s_delta_logs
    path            = /path_to_logzilla/sphinx/data/idx_delta_logs
}
