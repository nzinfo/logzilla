#!/usr/bin/php
<?php include ("/path_to_logzilla/html/config/config.php");?>
<?php include ("/path_to_logzilla/html/includes/common_funcs.php");?>
#
# Sphinx configuration file for LogZilla
# Documentation for sphinx can be found at http://sphinxsearch.com/docs/
#

#############################################################################
## indexer settings
#############################################################################
indexer
{
        # Set to your liking, default is 32M, but I have 26G available
        # so I set it to 1024M (max recommended in the docs)
        # A more "sane" setting would be 256M which will process about 600k rows at a time
        # See http://sphinxsearch.com/docs/current.html#conf-mem-limit for more information
        mem_limit                       = 256M
}
#############################################################################
## searchd settings
#############################################################################
searchd
{

        listen                         = 127.0.0.1
        port                            = 3312
        # Max matches is set to 1000 by default
        # Note that if you make these numbers too high, you may run out of memory
        max_matches                 = 1000
        log                                     = /path_to_logzilla/sphinx/log/sphinx_searchd.log
        query_log                       = /path_to_logzilla/sphinx/log/sphinx_query.log
        read_timeout            = 5
        max_children            = 30
        seamless_rotate     = 1
        unlink_old                      = 1
        pid_file                        = /var/run/sphinx_searchd.pid
}
index distributed
{
                type = distributed
                                agent = 127.0.0.1:3312:idx_logs, idx_delta_logs
}
#############################################################################
## data source definition
#############################################################################
source s_logs
{
        type                            = mysql
        sql_host                        = <?php echo DBHOST."\n";?>
        sql_user                        = <?php echo DBADMIN."\n";?>
        sql_pass                        = <?php echo DBADMINPW."\n";?>
        sql_db                          = <?php echo DBNAME."\n";?>
        sql_port                        = <?php echo DBPORT."\n";?>     # optional, default is 3306
#        sql_host                        = 127.0.0.1
#        sql_user                        = syslogadmin
#        sql_pass                        = syslogadmin
#        sql_db                          = syslog
#        sql_port                        = 3306     # optional, default is 3306
        sql_query_range         = SELECT MIN(id),MAX(id) FROM logs
        # set range step to whatever you like, 1m on larger systems should be ok
        # See http://sphinxsearch.com/docs/current.html#conf-sql-range-step
        sql_range_step      = 100000
        sql_query_pre           = UPDATE sph_counter SET max_id= (SELECT MAX(id) FROM logs) WHERE index_name = 'idx_logs'
        sql_query                       = SELECT \
                                                        id, host, facility, priority, tag, program, \
                                                        msg, counter, UNIX_TIMESTAMP(fo) AS fo, UNIX_TIMESTAMP(lo) AS lo \
                                                        FROM logs\
                                                WHERE id >= $start AND id <= $end
        sql_attr_timestamp      = fo
        sql_attr_timestamp      = lo
        sql_query_post          =
        sql_query_info          = SELECT * FROM logs WHERE id=$id
}

source s_delta_logs : s_logs
{
        sql_query_pre           = UPDATE sph_counter SET max_id= (SELECT MAX(id) FROM logs) \
                                                        WHERE index_name = 'idx_delta_logs'
        sql_query_range         = SELECT \
                                                        MIN(id),MAX(id) FROM logs WHERE id > \
                                                        (SELECT max_id FROM sph_counter WHERE index_name = 'idx_logs')
}
#############################################################################
## index definition
#############################################################################
index idx_logs
{
        source                  = s_logs
        path                    = /path_to_logzilla/sphinx/data/idx_logs
        docinfo                 = extern
        min_word_len    = 3
        charset_type    = utf-8
}
index idx_delta_logs : idx_logs
{
    source          = s_delta_logs
    path            = /path_to_logzilla/sphinx/data/idx_delta_logs
}
