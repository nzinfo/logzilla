<?php
$basePath = dirname( __FILE__ );
require_once ($basePath . "/../common_funcs.php");
$dbLink = db_connect_syslog(DBADMIN, DBADMINPW);

$page = get_input('page');
$limit = get_input('rows');
$sidx = get_input('sidx');
$sord = get_input('sord');
$edit = get_input('action');

if(!$sidx) $sidx =1; 
$debugtxt = "POST and GET Variables passed to json.sadmin.php:\n";
foreach($_POST as $key => $value){
    $debugtxt .= $key.": ".$value."\n";
}
foreach($_GET as $key => $value){
    $debugtxt .= $key.": ".$value."\n";
}
$debugtxt .= "\n";

if ($edit == "1") {
    $sql = "UPDATE settings set $where";  
    $result = perform_query($sql, $dbLink, $_REQUEST['pageId']); 
}  else {
    //construct where clause 
    $where = "WHERE 1=1";

    $count = get_total_rows("settings", $dbLink, "$where");

    if( $count >0 ) { 
        $total_pages = ceil($count/$limit); 
        if ($page > $total_pages) $page=$total_pages; 
        $start = $limit*$page - $limit; // do not put $limit*($page - 1) 
        $response->page = $page; 
        $response->total = $total_pages; 
        $response->records = $count;

        $sql = "SELECT * FROM settings $where ORDER BY $sidx $sord LIMIT $start , $limit";  
        // $result = perform_query($sql, $dbLink, $_REQUEST['pageId']); 
        $result = perform_query($sql, $dbLink, $debugtxt); 
        $i=0; 
        while($row = fetch_array($result)) { 
            $response->rows[$i]['id']=$row['id']; 
            $response->rows[$i]['cell']=array($row['name'],$row['value'],$row['type'],$row['options'],$row['default'],$row['description']); 
            $i++; 
        } 
    } else { 
        // No results returned, display nothing...
        $total_pages = 0; 
        $response->total = $total_pages; 
    } 
}
echo json_encode($response); 
mysql_close($dbLink);
?>
